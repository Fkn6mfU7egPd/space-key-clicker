<!DOCTYPE html>
<html>
<!--
  Changelog
    v0.00                         Sep 18 2025 | start creating
    v0.01                         Sep 18 2025 | add score addition feature
    v0.01             @202509190957 / #IS0957 | adjust design
    v0.01             @202509191018 / #IS1018 | adjust design
    v0.01             @202509191021 / #IS1021 | adjust design
    v0.02-beta-1      @202509191115 / #IS1115 | add purchase system
    v0.02-beta-1      @202509191123 / #IS1123 | fix the key unresponsive bug
    v0.02-beta-2      @202509191242 / #IS1242 | upgrade purchase system
    v0.02             @202509191645 / #IS1645 | add auto click feature
    v0.03-beta-1      @202509191757 / #IS1757 | adjust design of price display
    v0.03-beta-1      @202509191804 / #IS1804 | upgrade build id generator
    v0.03-beta-1      @202509191825 / #IS1825 | fix build id 1mo 1d later bug
    v0.03-beta-1      @202509192217 / #IS2217 | add item block
    v0.03-beta-1      @202509192315 / #IS2315 | replace nextSibling to parentNode
    v0.03             @202509200053 / #IT0053 | fix long-pressing earn score bug
    v0.04-beta-1      @202509201517 / #IT1517 | add remain scores/clicks left feature
    v0.04-beta-1      @202509221148 / #IV1148 | make the changelog easier to reading and adjust design
    v0.04-beta-2      @202509241022 / #IX1022 | add mobile-friendly features
    v0.04-beta-3      @202509241032 / #IX1032 | fix item-clicking earn score bug
    v0.04-beta-4      @202509251047 / #IY1047 | add buyable count feature
    v0.04             @202509251411 / #IY1411 | add format config feature
    v0.05             @202509261114 / #IZ1114 | upgrade error handling
    v0.05             @202509261118 / #IZ1118 | reduce performance
    v1.00-rc-1        @202509270115 / #Ia0115 | add settings
    v1.00-rc-1        @202509270142 / #Ia0142 | add viewport

  Updating
    not in progress

  Planned updates
    v1.00-rc-2      no later than Oct 15 2025 | reduce performance and add fps display
    v1.00           no later than Oct 22 2025 | stable release
    v1.01           no later than Nov  6 2025 | add save/load system
    v1.02           no later than Nov 17 2025 | add save encryption system
    v1.03           no later than Dec 15 2026 | add cooltime system
    v1.04           no later than Jan  1 2026 | add cost performance sorting feature
    v1.05           no later than Feb  1 2026 | add musics and sounds
-->
<head>
  <meta charset="utf-8">
  <title>スペースキー連打 Web版</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inconsolata:wght@200..900&display=swap');

    body {
      user-select: none;
      --themecolor: lightblue;
    }

    #version {
      font-size: 12px;
      font-family: "Inconsolata", monospace;
      position: fixed;
      left: 0;
      top: 0;
      padding: 4px;
      background: white;
    }

    #powerDisplay {
      width: 100%;
      text-align: center;
      margin-top: 24px;
      margin-bottom: 24px;
    }

    #item-wrapper {
      display: flex;
      flex-direction: row;
      gap: 16px;
      justify-content: center;
    }

    div.item-group {
      display: flex;
      flex-direction: column;
    }

    div.item {
      border: 3px black solid;
      border-radius: 20px;
      display: flex;
      width: 150px;
      height: 80px;
      font-weight: 400;
      font-size: 24px;
      font-family: "Noto Sans JP", sans-serif;
      text-align: center;
      justify-content: center;
      align-items: center;
      margin: 12px;
      transition: background 0.1s linear;
    }

    div.item:hover {
      background: #e0e0e0;
    }

    div.remain-display {
      white-space: pre;
      font-size: 10px;
    }

    #score {
      font-weight: 400;
      font-size: 64px;
      font-family: "Inconsolata", monospace;
      text-align: center;
      position: sticky;
      width: 100%;
      top: 0px;
      margin-top: 40px;
    }

    #settings {
      position: fixed;
      top: 6px;
      right: 6px;
      margin: 0;
      padding: 8px;
      align-items: end;
      display: flex;
      flex-direction: column;
    }

    #settings-button {
      color: #767676;
      font-size: 40px;
    }

    .info {
      font-size: 12px;
      color: dimgray;
    }

    #settings-panel {
      transition: clip-path 0.3s ease-out;
      background: var(--themecolor);
      max-height: 80vh;
      overflow: scroll;
    }

    .rounded {
      border-radius: 16px;
      padding: 16px;
      margin: 8px;
    }
  </style>
</head>
<body>
  <div id="version">
    スペースキー連打 Web版, v1.00-rc-1 (@202509270142)<br>
    <strong id="version-short"></strong>
  </div>
  <div id="score">Loading...</div>
  <div id="powerDisplay">
    <div id="clickPowerDisplay">...</div>
    <div id="autoPowerDisplay">...</div>
  </div>
  <div id="settings">
    <div id="settings-button" class="material-symbols-rounded">settings</div>
    <div id="settings-panel" class="rounded" style="clip-path: inset(0 0 100% 0);">
      <h2>設定</h2>
      <h3>スケール方式</h3>
      <form id="scale-type">
        <label>
          <input type="radio" name="scale-type" value="Classic">クラシック
        </label>
        <label>
          <input type="radio" name="scale-type" value="Standard" checked>スタンダード (デフォルト)
        </label>
      </form>
      <div class="info">クラシック: Q, Qui, S, Sp...<br>スタンダード: Qa, Qi, Sx, Sp...</div>
      <h3>接尾辞の前のホワイトスペース</h3>
      <form id="whitespaceBeforeSuffix">
        <label>
          <input type="radio" name="whitespaceBeforeSuffix" value="no" checked>なし (デフォルト)
        </label>
        <label>
          <input type="radio" name="whitespaceBeforeSuffix" value="yes">あり
        </label>
      </form>
      <div class="info">なし: 123.4k, 133e36<br>あり: 123.4 k, 133 e36<br>(スタンダード/kは小文字で書かれています)</div>
      <h3>kを大文字にする</h3>
      <form id="uppercase-k">
        <label>
          <input type="radio" name="uppercase-k" value="no" checked>しない (デフォルト)
        </label>
        <label>
          <input type="radio" name="uppercase-k" value="yes">する
        </label>
      </form>
      <div class="info">しない: 123.4k<br>する: 123.4K<br>(接尾辞の前のホワイトスペースなしで書かれています)</div>
      <h3>テーマカラー (ベータ)</h3>
      <form id="themecolor" class="rounded" style="background: white;">
        <strong>基本色</strong><br>
        <label>
          <input type="radio" name="themecolor" value="lightblue" checked>
          <span style="color: lightblue;">●</span>ライトブルー (デフォルト)
        </label><br>
        <label>
          <input type="radio" name="themecolor" value="lightpink">
          <span style="color: lightpink;">●</span>ライトピンク
        </label><br>
        <label>
          <input type="radio" name="themecolor" value="lightgray">
          <span style="color: lightgray;">●</span>ライトグレー
        </label><br>
        <strong>その他の色</strong><br>
        <label>
          <input type="radio" name="themecolor" value="mediumaquamarine">
          <span style="color: mediumaquamarine;">●</span>ミントグリーン
        </label><br>
        <label>
          <input type="radio" name="themecolor" value="lightgreen">
          <span style="color: lightgreen;">●</span>グリーン
        </label><br>
        <label>
          <input type="radio" name="themecolor" value="plum">
          <span style="color: plum;">●</span>マゼンタ
        </label><br>
        <label>
          <input type="radio" name="themecolor" value="peachpuff">
          <span style="color: peachpuff;">●</span>ベージュ
        </label><br>
        <label>
          <input type="radio" name="themecolor" value="paleturquoise">
          <span style="color: paleturquoise;">●</span>シアン
        </label><br>
        <label>
          <input type="radio" name="themecolor" value="thistle">
          <span style="color: thistle;">●</span>パープル
        </label><br>
        <label>
          <input type="radio" name="themecolor" value="wheat">
          <span style="color: wheat;">●</span>イエロー
        </label><br>
        <label>
          <input type="radio" name="themecolor" value="burlywood">
          <span style="color: burlywood;">●</span>ブラウン
        </label><br>
        <label>
          <input type="radio" name="themecolor" value="skyblue">
          <span style="color: skyblue;">●</span>スカイブルー
        </label><br>
      </form>
      <h3>デザイン (準備中)</h3>
      <form id="design">
        <label>
          <input type="radio" name="design" value="Original" disabled>
          オリジナル
        </label><br>
        <label>
          <input type="radio" name="design" value="Modern" checked>
          モダン (デフォルト)
        </label>
      </form>
      <div class="info">オリジナル: 角張ったデザイン<br>モダン: 丸っこいデザイン</div>
    </div>
  </div>
  <div id="item-wrapper">
    <div class="item-group">
      <div class="item-block">
        <div class="item" data-price="20" data-multiplier="1.1" data-action="cp" data-amount="1">手動<br>+1</div>
      </div>

      <div class="item-block">
        <div class="item" data-price="100" data-multiplier="1.1" data-action="cm" data-amount="0.05">手動<br>+5%</div>
      </div>

      <div class="item-block">
        <div class="item" data-price="100e3" data-multiplier="1.1" data-action="cp" data-amount="100">手動<br>+100</div>
      </div>

      <div class="item-block">
        <div class="item" data-price="1e3" data-multiplier="3.6" data-action="mcp" data-amount="2">手動<br>×2</div>
      </div>

      <div class="item-block">
        <div class="item" data-price="100e6" data-multiplier="1.8" data-action="cp" data-amount="5e6">手動<br>+5M</div>
      </div>

      <div class="item-block">
        <div class="item" data-price="100e3" data-multiplier="8.5" data-action="mcp" data-amount="3">手動<br>×3</div>
      </div>

      <div class="item-block">
        <div class="item" data-price="20e9" data-multiplier="2.6" data-action="cm" data-amount="80">手動<br>+80%</div>
      </div>
    </div>
    <!--
    <div class="item-group">
      <div class="item-block">
        <div class="item" data-price="999e99999" data-multiplier="999E99999">アイテム<br>値段減少</div>
      </div>
    </div>
    -->
    <div class="item-group">
      <div class="item-block">
        <div class="item" data-price="100" data-multiplier="1.1" data-action="ap" data-amount="1">自動<br>+1</div>
      </div>

      <div class="item-block">
        <div class="item" data-price="500" data-multiplier="1.1" data-action="am" data-amount="0.05">自動<br>+5%</div>
      </div>

      <div class="item-block">
        <div class="item" data-price="1e6" data-multiplier="1.1" data-action="ap" data-amount="100">自動<br>+100</div>
      </div>

      <div class="item-block">
        <div class="item" data-price="3e3" data-multiplier="3.6" data-action="map" data-amount="2">自動<br>×2</div>
      </div>

      <div class="item-block">
        <div class="item" data-price="300e6" data-multiplier="1.8" data-action="ap" data-amount="5e6">自動<br>+5M</div>
      </div>

      <div class="item-block">
        <div class="item" data-price="300e3" data-multiplier="8.5" data-action="map" data-amount="3">自動<br>×3</div>
      </div>

      <div class="item-block">
        <div class="item" data-price="60e9" data-multiplier="2.6" data-action="am" data-amount="0.8">自動<br>+80%</div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/break_infinity.js@2.2.0/dist/break_infinity.min.js"></script>
  <script>
    const scoreElem = document.getElementById("score");
    const items = Array.from(document.getElementsByClassName("item"));
    const settingsButton = document.getElementById("settings-button");
    const formatter = (factor, num = score) => num.div(new Decimal(factor)).toPrecision(3);

    let score = new Decimal(0);
    let clickPower = new Decimal(1);
    let clickMultiplier = new Decimal(1);
    let autoPower = new Decimal(0);
    let autoMultiplier = new Decimal(1);
    let prevTime = Date.now();
    let pressing = false;
    let formatCfg = {
      type: "Standard", // Classic (Q,Qui,S,Sp...) | Standard (Qa,Qi,Sx,Sp...)
      whitespaceBeforeSuffix: false, // false (e.g. 123.4k, 133e36) | true (e.g. 123.4 k, 133 e36) | (sample is written on standard type and lowercase k)
      uppercaseK: false, // false (e.g. 123.4k) | true (e.g. 123.4K) | (sample is written on no whitespace before suffix)
    };
    let isSettingsPanelOpen = false;

    document.getElementById("scale-type").addEventListener("change", event => {
      switch (event.target.value){
        case "Classic": formatCfg.type = "Classic"; break;
        case "Standard": formatCfg.type = "Standard"; break;
      }
    });

    document.getElementById("whitespaceBeforeSuffix").addEventListener("change", event => {
      switch (event.target.value){
        case "no": formatCfg.whitespaceBeforeSuffix = false; break;
        case "yes": formatCfg.whitespaceBeforeSuffix = true; break;
      }
    });

    document.getElementById("uppercase-k").addEventListener("change", event => {
      switch (event.target.value){
        case "no": formatCfg.uppercaseK = false; break;
        case "yes": formatCfg.uppercaseK = true; break;
      }
    });

    document.getElementById("themecolor").addEventListener("change", event => {
      document.body.style.setProperty("--themecolor", event.target.value);
    });

    // 有効数字digits桁まで切り落とす
    const toExponential = (num, digits = 3) => {
      num = num.abs();
      if (num.equals(0)) return "0";
      const mantissa = (num.mantissa * (10 ** Math.floor(num.log10() % 3)));
      return mantissa.toPrecision(digits) + (formatCfg.whitespaceBeforeSuffix ? " " : "") + (formatCfg.type === "Classic" ? "E" : "e") + Math.floor(num.log10() / 3) * 3;
    }

    addEventListener("click", event => {
      if (event.target.classList.contains("item") || event.target.closest("#settings")) return;
      score = score.plus(clickPower.mul(clickMultiplier))
    });

    settingsButton.addEventListener("click", () => {
      if (isSettingsPanelOpen){
        document.getElementById("settings-panel").style.clipPath = "inset(0 0 100% 0)";
        isSettingsPanelOpen = !isSettingsPanelOpen;
      }else{
        document.getElementById("settings-panel").style.clipPath = "inset(0 0 0 0)";
        isSettingsPanelOpen = !isSettingsPanelOpen;
      }
    });

    addEventListener("keydown", event => {
      if (event.key === " "){
        event.preventDefault();
        if (pressing) return;
        pressing = true;
        score = score.plus(clickPower.mul(clickMultiplier));
      }
    });

    addEventListener("keyup", event => {
      if (event.key === " ") pressing = false;
    });

    document.querySelectorAll('.item').forEach(item => {
      item.addEventListener('click', () => {
        const dataset = item.dataset;

        const price = new Decimal(dataset.price);
        const multiplier = new Decimal(dataset.multiplier);
        const amount = new Decimal(dataset.amount);
        const action = dataset.action;

        if (score.lt(price)) return;

        score = score.sub(price);

        dataset.price = price.mul(multiplier).toString();

        switch(action) {
          case "cp": clickPower = clickPower.plus(amount); break;
          case "cm": clickMultiplier = clickMultiplier.plus(amount); break;
          case "ap": autoPower = autoPower.plus(amount); break;
          case "am": autoMultiplier = autoMultiplier.plus(amount); break;
          case "mcp": clickPower = clickPower.mul(amount); break;
          case "map": autoPower = autoPower.mul(amount); break;
          default: console.warn("Unknown action:", action);
        }
      });
    });

    function formatNumber(num){
      num = new Decimal(num);
      const suffixes = (formatCfg.type === "Standard") ? [
        {exp: 3, suffix: (formatCfg.uppercaseK ? "K" : "k")},
        {exp: 6, suffix: "M"},
        {exp: 9, suffix: "B"},
        {exp: 12, suffix: "T"},
        {exp: 15, suffix: "Qa"},
        {exp: 18, suffix: "Qi"},
        {exp: 21, suffix: "Sx"},
        {exp: 24, suffix: "Sp"},
        {exp: 27}
      ] : (formatCfg.type === "Classic") ? [
        {exp: 3, suffix: (formatCfg.uppercaseK ? "K" : "k")},
        {exp: 6, suffix: "M"},
        {exp: 9, suffix: "B"},
        {exp: 12, suffix: "T"},
        {exp: 15, suffix: "Q"},
        {exp: 18, suffix: "Qui"},
        {exp: 21, suffix: "S"},
        {exp: 24, suffix: "Sp"},
        {exp: 27}
      ] : [
        {exp: 0}
      ];
      suffixes.sort((a, b) => b.exp - a.exp);

      if (num.exponent >= suffixes[0].exp){
        return toExponential(num);
      }else if (num.exponent < suffixes.at(-1).exp){
        return formatter('1', num);
      }else{
        for (const suffix of suffixes){
          if (num.exponent >= suffix.exp){
            return formatter('1e' + suffix.exp, num) + (formatCfg.whitespaceBeforeSuffix ? " " : "") + suffix.suffix;
          }
        }
      }
    }

    items.forEach(item => {
      const priceDisplay = document.createElement("div");
      priceDisplay.className = "price-display";
      item.parentElement.append(priceDisplay);

      const remainDisplay = document.createElement("div");
      remainDisplay.className = "remain-display";
      item.parentElement.append(remainDisplay);
    });

    const alphabets = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");
    const version = document.getElementById('version').textContent;
    const match = version.match(/@(\d{4})(\d{2})(\d{2})(\d{4})/);
    if (match) {
      const [date, year, month, day, time] = match;
      const buildId = 'build #' +
        alphabets[parseInt(month) - 1] +
        alphabets[parseInt(day) - 1] +
        time;
      document.getElementById('version-short').textContent = buildId;
    }

    function maxPurchasesFormula(a, x, y){ // 初期価格、倍率、所持金
      if (x.equals(1)) return y.div(a).floor();
      const one = new Decimal(1)
      const threshold = one.minus(y.div(a).mul(one.minus(x)));
      if (threshold.lte(0)) return 0;

      const n = Decimal.log(threshold, x);
      return Math.floor(n);
    }

    function tick(){
      items.forEach(item => {
        const price = new Decimal(item.dataset.price);
        const parent = item.parentElement;
        parent.getElementsByClassName("price-display")[0].textContent = "値段: " + formatNumber(price);

        const remainDisplay = parent.getElementsByClassName("remain-display")[0];
        const remain = price.minus(score)
        if (score.lt(price)){
          remainDisplay.textContent = "あと" + formatNumber(remain) + "スコア\n";
          remainDisplay.textContent += "(" + formatNumber(remain.div(clickPower.mul(clickMultiplier))) + "クリック";
          if (autoPower.eq(0)){
            remainDisplay.textContent += ")";
          }else{
            remainDisplay.textContent += " / " + formatNumber(remain.div(autoPower.mul(autoMultiplier))) + "秒)";
          };
        }else{
          remainDisplay.textContent = "あと" + maxPurchasesFormula(price, new Decimal(item.dataset.multiplier), score).toString() + "個購入可能";
        }
      });

      document.getElementById("clickPowerDisplay").textContent = "クリックパワー: " +
      formatNumber(clickPower.mul(clickMultiplier)) + " (" +
      formatNumber(clickPower) + " +" + formatNumber(clickMultiplier.minus(1).mul(100)) + "%)";

      document.getElementById("autoPowerDisplay").textContent = "自動: " +
      formatNumber(autoPower.mul(autoMultiplier)) + " (" +
      formatNumber(autoPower) + " +" + formatNumber(autoMultiplier.minus(1).mul(100)) + "%)";

      scoreElem.textContent = formatNumber(score);
      score = score.plus(autoPower.mul(autoMultiplier).mul((Date.now() - prevTime) / 1000));
      prevTime = Date.now();
      requestAnimationFrame(tick);
    }

    tick();
  </script>
</body>
</html>